<!doctype html><html><meta http-equiv=content-type content="text/html" charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Attacktive Directory</title><link rel="shortcut icon" href=https://schmid7k.github.io/s-for-security/images/favicon.png type=image/png><meta name=description content="Tips, tricks and write ups for Capture the Flag challenges."><meta name=keywords content="writeups,penetration-testing,cybersecurity,tryhackme,hackthebox"><meta name=referrer content="no-referrer-when-downgrade"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://schmid7k.github.io/s-for-security/css/screen.css><link rel=stylesheet href=https://schmid7k.github.io/s-for-security/css/fonts.css type=text/css><link rel=stylesheet href=https://schmid7k.github.io/s-for-security/fork-awesome/css/fork-awesome.min.css type=text/css><meta property="og:title" content="Attacktive Directory"><meta property="og:description" content="This write up refers to the Attacktive Directory room on TryHackMe.
Task 1: Deploy the machine Questions 1 - 3) Deploy the machine attached to this room and connect yourself to the TryHackMe network.
Task 2: Setup Follow the instructions for installing Impacket, Bloodhound and Neo4j.
Question 4) When you have installed the required tools click the Completed button to continue.
Task 3: Welcome to Attacktive Directory We begin with some basic enumeration."><meta property="og:type" content="article"><meta property="og:url" content="https://schmid7k.github.io/s-for-security/posts/tryhackme/cyber_defense/attacktive_directory/"><meta property="og:image" content="https://schmid7k.github.io/s-for-security/images/cover-image.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-04T18:23:05+02:00"><meta property="article:modified_time" content="2022-04-04T18:23:05+02:00"><meta property="og:site_name" content="S for Security"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://schmid7k.github.io/s-for-security/images/cover-image.jpg"><meta name=twitter:title content="Attacktive Directory"><meta name=twitter:description content="This write up refers to the Attacktive Directory room on TryHackMe.
Task 1: Deploy the machine Questions 1 - 3) Deploy the machine attached to this room and connect yourself to the TryHackMe network.
Task 2: Setup Follow the instructions for installing Impacket, Bloodhound and Neo4j.
Question 4) When you have installed the required tools click the Completed button to continue.
Task 3: Welcome to Attacktive Directory We begin with some basic enumeration."><meta itemprop=name content="Attacktive Directory"><meta itemprop=description content="This write up refers to the Attacktive Directory room on TryHackMe.
Task 1: Deploy the machine Questions 1 - 3) Deploy the machine attached to this room and connect yourself to the TryHackMe network.
Task 2: Setup Follow the instructions for installing Impacket, Bloodhound and Neo4j.
Question 4) When you have installed the required tools click the Completed button to continue.
Task 3: Welcome to Attacktive Directory We begin with some basic enumeration."><meta itemprop=datePublished content="2022-04-04T18:23:05+02:00"><meta itemprop=dateModified content="2022-04-04T18:23:05+02:00"><meta itemprop=wordCount content="1320"><meta itemprop=image content="https://schmid7k.github.io/s-for-security/images/cover-image.jpg"><meta itemprop=keywords content><body><main class="content page-template page-" role=main><article class="post page"><header class=post-header><a id=blog-logo href=/s-for-security/>S for Security</a></header><h1 class=post-title>Attacktive Directory</h1><section class=post-content><p>This write up refers to the <a href=https://tryhackme.com/room/attacktivedirectory>Attacktive Directory</a> room on <a href=https://tryhackme.com/>TryHackMe</a>.</p><h4 id=task-1-deploy-the-machine>Task 1: Deploy the machine</h4><h5 id=questions-1---3>Questions 1 - 3)</h5><p>Deploy the machine attached to this room and connect yourself to the TryHackMe network.</p><h4 id=task-2-setup>Task 2: Setup</h4><p>Follow the instructions for installing Impacket, Bloodhound and Neo4j.</p><h5 id=question-4>Question 4)</h5><p>When you have installed the required tools click the <code>Completed</code> button to continue.</p><h4 id=task-3-welcome-to-attacktive-directory>Task 3: Welcome to Attacktive Directory</h4><p>We begin with some basic enumeration. I&rsquo;ll be using <code>rustscan</code> for that though <code>nmap</code> is also just fine.</p><p><code>rustscan -a &lt;ip_address> -- -A -sC -sV</code></p><p>And we find a whole bunch of open ports</p><pre tabindex=0><code>PORT      STATE SERVICE       REASON  VERSION
53/tcp    open  domain        syn-ack Simple DNS Plus
80/tcp    open  http          syn-ack Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
88/tcp    open  kerberos-sec  syn-ack Microsoft Windows Kerberos (server time: 2022-04-07 12:26:52Z)
135/tcp   open  msrpc         syn-ack Microsoft Windows RPC
139/tcp   open  netbios-ssn   syn-ack Microsoft Windows netbios-ssn
389/tcp   open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: spookysec.local0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds? syn-ack
464/tcp   open  kpasswd5?     syn-ack
593/tcp   open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped    syn-ack
3268/tcp  open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: spookysec.local0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped    syn-ack
3389/tcp  open  ms-wbt-server syn-ack Microsoft Terminal Services
5985/tcp  open  http          syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        syn-ack .NET Message Framing
47001/tcp open  http          syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc         syn-ack Microsoft Windows RPC
49665/tcp open  msrpc         syn-ack Microsoft Windows RPC
49667/tcp open  msrpc         syn-ack Microsoft Windows RPC
49669/tcp open  msrpc         syn-ack Microsoft Windows RPC
49670/tcp open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
49671/tcp open  msrpc         syn-ack Microsoft Windows RPC
49673/tcp open  msrpc         syn-ack Microsoft Windows RPC
49677/tcp open  msrpc         syn-ack Microsoft Windows RPC
49682/tcp open  msrpc         syn-ack Microsoft Windows RPC
49694/tcp open  msrpc         syn-ack Microsoft Windows RPC
49806/tcp open  msrpc         syn-ack Microsoft Windows RPC
Service Info: Host: ATTACKTIVEDIREC; OS: Windows; CPE: cpe:/o:microsoft:windows
</code></pre><h5 id=question-5-what-tool-will-allow-us-to-enumerate-port-139445>Question 5) What tool will allow us to enumerate port 139/445?</h5><p>From the enumeration results we found out that port 139 is related to a <code>netbios-ssn</code> service and port 445 to a <code>microsoft-ds</code> service. These indicate the usage of <code>samba</code>.</p><p>One particular tool that comes to mind when you want to enumerate samba shares from Linux is <code>enum4linux</code>.</p><p><strong>Solution:</strong> enum4linux</p><h5 id=question-6-what-is-the-netbios-domain-name-of-the-machine>Question 6) What is the NetBIOS-Domain Name of the machine?</h5><p>Executing <code>enum4linux 10.10.1.8</code> provides us with the information needed to answer this question.</p><p><strong>Solution:</strong> THM-AD</p><h5 id=question-7-what-invalid-tld-do-people-commonly-use-for-their-active-directory-domain>Question 7) What invalid TLD do people commonly use for their Active Directory Domain?</h5><p>This requires some external research.</p><p><strong>Solution:</strong> .local</p><h4 id=task-4-enumerating-users-via-kerberos>Task 4: Enumerating Users via Kerberos</h4><p>Download <a href=https://github.com/ropnop/kerbrute/releases>Kerbrute</a>, the <a href=https://raw.githubusercontent.com/Sq00ky/attacktive-directory-tools/master/userlist.txt>user-list</a> and the <a href=https://raw.githubusercontent.com/Sq00ky/attacktive-directory-tools/master/passwordlist.txt>password-list</a>. Make sure to download Kerbrute version 1.0.2 though, because 1.0.3 does not have to UserEnum flag.</p><h5 id=question-8-what-command-within-kerbrute-will-allow-us-to-enumerate-valid-usernames>Question 8) What command within Kerbrute will allow us to enumerate valid usernames?</h5><p>Executing <code>kerbrute --help</code> should give you the answer.</p><p><strong>Solution:</strong> userenum</p><h5 id=question-9-what-notable-account-is-discovered-these-should-jump-out-at-you>Question 9) What notable account is discovered? (These should jump out at you)</h5><p>Looking through kerbrute&rsquo;s help menu is everything we need to learn how to use kerbrute. We can enumerate username on the target machine with the following command</p><p><code>kerbrute userenum userlist.txt --dc &lt;ip_addr> -d domain name</code></p><p>This gives us a list of usernames, two of which should stick out immediately.</p><p><strong>Solution:</strong> svc-admin</p><h5 id=question-10-what-is-the-other-notable-account-is-discovered-these-should-jump-out-at-you>Question 10) What is the other notable account is discovered? (These should jump out at you)</h5><p><strong>Solution:</strong> backup</p><h4 id=task-5-abusing-kerberos>Task 5: Abusing Kerberos</h4><p>The intro text tells us about how we are now able to abuse a feature within Kerberos with an attack method called <code>ASREPRoasting</code>.
This occurs when a user account has the privilege &ldquo;Does not require Pre-Authentication&rdquo; set, meaning that the account does not need to provide valid identification before requesting a Kerberos Ticket.</p><p>We can exploit this using <code>impacket's</code> tool <code>GetNPUsers.py</code> located in <code>impacket/examples/GetNPUsers.py</code>, by querying ASRERoastable accounts from the Key Distribution Center. We only need a valid set of usernames, which we have from the <code>kerbrute</code> enumeration.</p><h5 id=question-11-we-have-two-user-accounts-that-we-could-potentially-query-a-ticket-from-which-user-account-can-you-query-a-ticket-from-with-no-password>Question 11) We have two user accounts that we could potentially query a ticket from. Which user account can you query a ticket from with no password?</h5><p>Executing <code>GetNPUsers.py -dc &lt;ip_addr> -no-pass -format john -o hash.txt &lt;domain_name>/&lt;username></code> with the correct username should retrieve a hash from the target machine.</p><p><strong>Solution:</strong> svc-admin</p><h5 id=question-12-looking-at-the-hashcat-examples-wiki-page-what-type-of-kerberos-hash-did-we-retrieve-from-the-kdc-specify-the-full-name>Question 12) Looking at the Hashcat Examples Wiki page, what type of Kerberos hash did we retrieve from the KDC? (Specify the full name)</h5><p>Searching the <a href="https://hashcat.net/wiki/doku.php?id=example_hashes">hashcat examples</a> page for the first part of the returned hash leads to the answer.</p><p><strong>Solution:</strong> Kerberos 5, etype 23, AS-REP</p><h5 id=question-13-what-mode-is-the-hash>Question 13) What mode is the hash?</h5><p>Executing <code>hashcat --help</code> and <code>grep</code> for the name of the hash gives us the answer.</p><p><strong>Solution:</strong> 18200</p><h5 id=question-14-now-crack-the-hash-with-the-modified-password-list-provided-what-is-the-user-accounts-password>Question 14) Now crack the hash with the modified password list provided, what is the user accounts password?</h5><p><code>hashcat -a 0 -m 18200 hash.txt passwordlist.txt</code> should be able to crack the hash in no time.</p><p><strong>Solution:</strong> man***********</p><h4 id=task-6-back-to-the-basics>Task 6: Back to the Basics</h4><p>We now have a user&rsquo;s account credentials giving us a lot more access within the domain. Let&rsquo;s proceed by enumerating any shares that the domain controller may be giving out.</p><h5 id=question-15-what-utility-can-we-use-to-map-remote-smb-shares>Question 15) What utility can we use to map remote SMB shares?</h5><p>Some external research quickly leads to one popular tool for connecting to SMB shares.</p><p><strong>Solution:</strong> smbclient</p><h5 id=question-16-which-option-will-list-shares>Question 16) Which option will list shares?</h5><p><code>smbclient --help</code> gives us an overview of common commands and holds the answer to the question.</p><p><strong>Solution:</strong> -L</p><h5 id=question-17-how-many-remote-shares-is-the-server-listing>Question 17) How many remote shares is the server listing?</h5><p>Executing <code>smbclient -U &lt;username> -L &lt;ip_addr></code> prompts us for a password. Luckily this is the password we cracked in question 14!</p><p><strong>Solution:</strong> 6</p><h5 id=question-18-there-is-one-particular-share-that-we-have-access-to-that-contains-a-text-file-which-share-is-it>Question 18) There is one particular share that we have access to that contains a text file. Which share is it?</h5><p>Trying out all the possible shares yields that we have access to the <code>backup</code> share. Connecting to it with <code>smbclient -U &lt;username> \\\\&lt;ip_addr>\\backup</code> and authenticating with the cracked password allows us to retrieve a file from the share.</p><p><strong>Solution:</strong> backup</p><h5 id=question-19-what-is-the-content-of-the-file>Question 19) What is the content of the file?</h5><p>Looking at the contents of the file we retrieved from the backup share shows, that they contain some kind of encoded backup credentials.</p><p><strong>Solution:</strong> YmFja********************************************</p><h5 id=question-20-decoding-the-contents-of-the-file-what-is-the-full-contents>Question 20) Decoding the contents of the file, what is the full contents?</h5><p>Giving the encoded string to <a href=https://cyberchef.org/>cyberchef</a> and using the <code>Magic</code> recipe shows that it was encoded using <code>Base64</code>.</p><p><strong>Solution:</strong> <a href=mailto:backup@spookysec.local>backup@spookysec.local</a>:*************</p><h4 id=task-7-elevating-privileges-within-the-domain>Task 7: Elevating Privileges within the Domain</h4><p>The task description tells us that the credentials we just retrieved are related to the backup account of the Domain Controller. This account has a unique permission that allows all Active Directory changes to be synced with this user account, including password hashes.</p><p>With this knowledge and the usage of another Impacket tool called <code>secretsdump.y</code> we can retrieve all password hashes that his user account has to offer, giving us essentially full control over the AD domain.</p><h5 id=question-21-what-method-allowed-us-to-dump-ntdsdit>Question 21) What method allowed us to dump NTDS.DIT?</h5><p>Executing <code>secretsdump.py &lt;username>:&lt;password>@&lt;ip_addr></code> yields the answer and a lot of hashes.</p><p><strong>Solution:</strong> DRSUAPI</p><h5 id=question-22-what-is-the-administrators-ntlm-hash>Question 22) What is the Administrators NTLM hash?</h5><p><strong>Solution:</strong> 0e03*****************************</p><h5 id=question-23-what-method-of-attack-could-allow-us-to-authenticate-as-the-user-without-the-password>Question 23) What method of attack could allow us to authenticate as the user without the password?</h5><p>This requires some external research.</p><p><strong>Solution:</strong> Pass the Hash</p><h5 id=question-24-using-a-tool-called-evil-winrm-what-option-will-allow-us-to-use-a-hash>Question 24) Using a tool called Evil-WinRM what option will allow us to use a hash?</h5><p>As always we can take a look at the help menu by calling <code>evil-winrm --help</code>.</p><p><strong>Solution:</strong> -H</p><h4 id=task-8-flag-submission-panel>Task 8: Flag Submission Panel</h4><p>Now that we basically have full access to the AD domain we can login as admin to get the user flags from their respective desktop folders.</p><h5 id=question-25-svc-admin>Question 25) svc-admin</h5><p><strong>Solution:</strong> TryHackMe{#################}</p><h5 id=question-26-backup>Question 26) backup</h5><p><strong>Solution:</strong> TryHackMe{###############}</p><h5 id=question-27-administrator>Question 27) Administrator</h5><p><strong>Solution:</strong> TryHackMe{######################}</p><p>Congratulations, you finished the <a href=https://tryhackme.com/room/attacktivedirectory>Attacktive Directory</a> room on <a href=https://tryhackme.com/>TryHackMe</a>!</p></section></article></main><footer class=site-footer><div class=inner><section class=copyright>©Schmid7k</section><section></section><section><a href=https://themes.gohugo.io/hugo-scroll/>Design</a> template
built with ♥️ by
<a href=https://www.janraasch.com title="Jan Raasch">Jan Raasch</a></section></div></footer><script type=text/javascript src=https://schmid7k.github.io/s-for-security/js/jquery-1.11.3.min.js></script>
<script type=text/javascript src=https://schmid7k.github.io/s-for-security/js/icons.js></script>
<script type=text/javascript src=https://schmid7k.github.io/s-for-security/js/index.js></script></body></html>