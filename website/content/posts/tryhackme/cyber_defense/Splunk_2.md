---
title: "Splunk 2"
date: 2022-03-29T19:11:39+02:00
draft: false
---

This write up refers to the [Splunk 2](https://tryhackme.com/room/splunk2gcd5) room on [TryHackMe](https://tryhackme.com/).

In [Splunk 101](https://tryhackme.com/room/splunk101) we were taught the very basics of how to install and use Splunk. Now it's time to tackle som real challenges!

#### Task 1: Deploy!

This room works with data generated by members of Splunk's Security Specialist team based on version 2 of the Boss of the SOC (BOTS) competition by Splunk.

[BOTSv2 Github](https://github.com/splunk/botsv2)

##### Question 1

Deploy the attached VM and connect to it via `http://<vm_ip>:8000`. Then click the `Completed` button.

#### Task 2: Dive into the data

We are roleplaying as Alice Bluebird, an analyst who successfully assisted Wayne Enterprises and was recommended to Grace Hoppy at Frothly to assist them with their recent issues.

To find out what events we are dealing with use the `metadata` command to search for the same kind of information found in the Data Summary, while also being able to search within a specific index. Since all time-values are EPOCH time we also need the `eval` command to provide more human-friendly formatting.

The following example searches the botsv2 index and returns a listing of all the source types that can be found as well as a count of events and the first time and last time seen.

`| metadata type=sourcetypes index=botsv2 | eval firstTime=strftime(firstTime,"%Y-%m-%d %H:%M:%S") | eval lastTime=strftime(lastTime,"%Y-%m-%d %H:%M:%S") | eval recentTime=strftime(recentTime,"%Y-%m-%d %H:%M:%S") | sort - totalCount`

##### Question 2

Click the `Completed` button.

#### Task 3: 100 series questions

For now we focus on BOTSv2 questions 100-104. Our focus is a person called Amber Turing and her communication with a competitor.

**Question 1:**

Find out what competitor website she visited. Begin with the following command to search for Amber's IP address `index="botsv2" amber`. This command will produce a lot of events though you can find her IP in the first page. However, to get her IP easily try this `index = "botsv2" sourcetype="pan:traffic" amber`. This gives us `10.0.2.101` as her IP.

Given this information we can build new search queries and focus on her HTTP traffic like this `index = "botsv2" IPADDR sourcetype="stream:HTTP"`.

However, this still produces a lot of results to go through just to find the website of the competitor she was looking at. Let's try narrowing it down a bit further by making use of the `site` field and displaying the output in a table like so `index="botsv2" IPADDR sourcetype="stream:HTTP" | dedup site | table site`.

With this search it should be easy to find the website Amber connected to, just think about which company Amber works for and in which industry branch. You can even narrow it down further `index="botsv2" IPADDR sourcetype="stream:HTTP" *INDUSTRY* | dedup site | table site` giving us `www.berkbeer.com`

**Question 2-7:**

We now know that Amber found the executive contact information and sent him an email. Based on question 2, it has to be an image. With this knowledge it is easy to construct a new query to narrow down Amber's HTTP traffic to the competitor website.

`index="botsv2" IPADDR sourcetype="stream:HTTP" COMPETITOR_WEBSITE`

Expand on this command to get the specific field we want and output it in table format as previously

Try `index="botsv2" IPADDR sourcetype="stream:HTTP" COMPETITOR_WEBSITE /images/* |  table uri_path` to get `/images/ceoberk.png`.

Now we need Amber's email to look at the SMTP traffic between her and the CEO of berkbeer. Try `index="botsv2" sourcetype="stream::SMTP" *amber*`, giving us `aturing@froth.ly` as her email.

We have the last name of the CEO and Amber's email, to get his full name however we need to focus on the email traffic between Amber and the CEO. Try this command `index="botsv2" sourcetype="stream:SMTP" AMBERS_EMAIL COMPETITOR_WEBSITE`. Paying attention to the email conversation by looking at the `content_body` header reveals his full name `Martin Berk`.

With all this information we can solve the challenges attached to this task.

##### Question 3) Amber Turing was hoping for Frothly to be acquired by a potential competitor which fell through, but visited their website to find contact information for their executive team. What is the website domain that she visited?

**Solution:** www.berkbeer.com

##### Question 4) Amber found the executive contact information and sent him an email. What image file displayed the executive's contact information? Answer example: /path/image.ext

**Solution:** /images/ceoberk.png

*All following questions are answered by looking through the email conversation.*
##### Question 5) What is the CEO's name? Provide the first and last name.

**Solution:** Martin Berk

##### Question 6) What is the CEO's email address?

**Solution:** mberk@berkbeer.com

##### Question 7) After the initial contact with the CEO, Amber contacted another employee at this competitor. What is the employee's email address?

**Solution:** abernhard@berkbeer.com

##### Question 8) What is the name of the file attachment that Amber sent to a contact at the competitor?

**Solution:** Saccharomyces_cerevisiae_patent.docx 

##### Question 9) What is Amber's personal email address?

The content of the email this is discussed in is encoded in base64, you need to decode it first to get the solution.

**Solution:** ambersthebest@yeastiebeastie.com

#### Task 4: 200 series questions

Time to look at the 200 series questions.

**Question 1:**

Identify the Tor version Amber installed.

Try the keywords Amber and Tor in a query like this: `index="botsv2" amber tor`.

This query returns over 300 results, try reversing the order of results in case the first event is the Tor installation or try to add another keyword to the query like this: `index="botsv2" amber tor version`.

**Questions 2 & 3:**

Now we need to determine the public IP address for brewertalk.com and the IP address performing a web vulnerability scan against it.

For the public IP of brewertalk.com try `index="botsv2" sourcetype="stream:HTTP" brewertalk.com`.

For the IP address that performed the web vulnerability scan against brewertalk.com try `index="botsv2" sourcetype="stream:HTTP" brewertalk.com`.

**Questions 4 & 5:**

Build a new search query with the attacker's IP as source IP and change event sampling to 1:100.

Try `index="botsv2" src_ip="45.77.65.211"`.

This query will give you over 18.000 results! Use Interesting Fields to find out which URI path is being attacked.

Once you found the URI path construct a new query to search for the SQL function that was abused like this `index="botsv2" src_ip="ATTACKER_IP" uri_path="URI_PATH"`

**Questions 6 & 7:**

So far we identified Ambers Tor version and what URI path and SQL function is attacked on brewertalk.com.

Now we have to identify the cookie value that was transmitted as part of an XSS attack performed by the user Kevin.

Try getting some details on Kevin with this query `index="botsv2" kevin`.

Now you should have Kevin's first and last name. Try figuring out the cookie value from the XSS attack.

First you need to figure out Kevin's IP by searching for HTTP traffic with his name. Try `index="botsv2" sourcetype="stream:http" kevin`.

With his IP you can narrow down the result further by looking for traffic to brewertalk.com `index="botsv2" sourcetype="stream:http" src_ip="71.39.18.125" brewertalk.com`.

Looking at the cookie header of the results should give you the answer.

Inside of the results you will also find the answer to the username that was created as part of the spear phishing attack.

##### Question 10) What version of TOR Browser did Amber install to obfuscate her web browsing? Answer guidance: Numeric with one or more delimiter.

**Solution:** 7.0.4

##### Question 11) What is the public IPv4 address of the server running www.brewertalk.com?

**Solution:** 52.42.208.228

##### Question 12) Provide the IP address of the system used to run a web vulnerability scan against www.brewertalk.com.

**Solution:** 45.77.65.211

##### Question 13) The IP address from Q#2 is also being used by a likely different piece of software to attack a URI path. What is the URI path? Answer guidance: Include the leading forward slash in your answer. Do not include the query string or other parts of the URI. Answer example: /phpinfo.php

**Solution:** /member.php

##### Question 14) What SQL function is being abused on the URI path from the previous question?

**Solution:** updatexml

##### Question 15) What was the value of the cookie that Kevin's browser transmitted to the malicious URL as part of an XSS attack? Answer guidance: All digits. Not the cookie name or symbols like an equal sign.

**Solution:** 1502408189

##### Question 16) What brewertalk.com username was maliciously created by a spear phishing attack?

**Solution:** kIagerfield

#### Task 5: 300 series questions

Ok time to look at the 300 series questions.

**Question 1 & 2:**

This time we are looking into the individual named Mallory, her MacBook, and some encrypted files.

Begin by searching for events associated with Mallory like this `index="botsv2" mallory`.

This returns over 11,000 events but looking at Select Fields should give you the name of her MacBook.

Use this information to find events related to this host and add common file extensions for PowerPoint, since we are looking for a PowerPoint presentation `index="botsv2" host="MACBOOK_NAME" (*.ppt OR *.pptx)`.

The results should contain the name of the PowerPoint presentation before and after it was encrypted. The next thing to look out for is the movie file that was encrypted. By looking at the encrypted PowerPoint file you can find a sourcetype and an extension you can search for to find the other encrypted file like this `index="botsv2" host="MACBOOK_NAME" sourcetype="?" *.EXT`.

**Question 3-7:**

For the next task we need to provide the name of the manufacturer of the USB drive Kevin used on Mallory's personal MacBook (kutekitten).

We begin with the MacBook `index="botsv2" kutekitten`.

This should result in events from data sources that are related to Osquery. If you don't know Osquery yet I highly recommend doing the [Osquery](https://tryhackme.com/room/osqueryf8) room on TryHackMe first. I also have a write up for that [here]({{< relref "./Osquery.md" >}}).

Back to the results, try looking for Mallory's user folders, it's a good place to start hunting for malware. Once you have it expand your query like this `index="botsv2" kutekitten "\\/PATH\\/MALLORY\\/FOLDER"`.

Looking at the other available interesting fields related to paths can provide you with even better fields to include in your query and look for an interesting file, so make sure to pay attention to them.

Once you found the file (check its hash in VirusTotal) pivot and look at the events 1 minute prior by clicking on the date/time of the event and selecting in what relation to the current event you want to see others.

Search queries focused around that specific time segment will then allow you to find the event that was triggered when the USB was inserted. Though the events will not provide the name of the USB manufacturer directly, you have to perform external research on the ID value to get the answer.

##### Question 17)  Mallory's critical PowerPoint presentation on her MacBook gets encrypted by ransomware on August 18. What is the name of this file after it was encrypted?

**Solution:** Frothly_marketing_campaign_Q317.pptx.crypt

##### Question 18) There is a Games of Thrones movie file that was encrypted as well. What season and episode is it? 

**Solution:** S07E02

##### Question 18) Kevin Lagerfield used a USB drive to move malware onto kutekitten, Mallory's personal MacBook. She ran the malware, which obfuscates itself during execution. Provide the vendor name of the USB drive Kevin likely used. Answer Guidance: Use time correlation to identify the USB drive.

**Solution:** Alcor Micro Corp.

##### Question 19) What programming language is at least part of the malware from the question above written in?

**Solution:** Perl

##### Question 20) When was this malware first seen in the wild? Answer Guidance: YYYY-MM-DD

**Solution:** 2017-01-17

##### Question 21) The malware infecting kutekitten uses dynamic DNS destinations to communicate with two C&C servers shortly after installation. What is the fully-qualified domain name (FQDN) of the first (alphabetically) of these destinations?

**Solution:** eidk.duckdns.org

##### Question 22) From the question above, what is the fully-qualified domain name (FQDN) of the second (alphabetically) contacted C&C server?


**Solution:** eidk.hopto.org

#### Task 6: 400 series questions

Last but not least it's time to tackle the 400 series question from the BOTS2 dataset.

**Questions 1 & 2:**

Find the name of the attachment sent to Frothly by the malicious APT actor. The events are related to emails.

Try this command and replace the ? and .EXT appropriately `index="botsv2" sourcetype="stream:?" *.EXT`

**Question 3:**

Remind yourself of the IP address that scanned brewertalk.com.

Use that I and search the TCP stream for Interesting Fields `index="botsv2" sourcetype="stream:?" ATTACKER_IP`

**Question 4:**

An unusual file was downloaded with winsys32.dll. (Unusual as in unusual for an American company). Try `index="botsv2" winsys32.dll` to find out more.

The results should give present a tool associated with transferring files from system to system. Also there is a source type associated with the binary which you can use for a new query `index="botsv2" sourcetype="stream:?"`.

Since it was downloaded using winsys32.dll research commands that can be used with this tool to download things and add it to the query `index="botsv2" sourcetype="stream:?" method=COMMAND`.

**Question 5 & 6:**:

Given these sources you should be able to answer the questions by examining the execution of the malware.

- https://www.hybrid-analysis.com/sample/d8834aaa5ad6d8ee5ae71e042aca5cab960e73a6827e45339620359633608cf1/598155a67ca3e1449f281ac4
- https://www.virustotal.com/gui/file/d8834aaa5ad6d8ee5ae71e042aca5cab960e73a6827e45339620359633608cf1/detection
- https://app.any.run/tasks/15d17cd6-0eb6-4f52-968d-0f897fd6c3b3

**Question 7:**

Begin with `index="botsv2" schtasks.exe` and built on top of that

##### Question 23) A Federal law enforcement agency reports that Taedonggang often spear phishes its victims with zip files that have to be opened with a password. What is the name of the attachment sent to Frothly by a malicious Taedonggang actor?

**Solution:** invoice.zip

##### Question 24) What is the password to open the zip file?

**Solution:** 912345678

##### Question 25) The Taedonggang APT group encrypts most of their traffic with SSL. What is the "SSL Issuer" that they use for the majority of their traffic? Answer guidance: Copy the field exactly, including spaces.

**Solution:** C = US

##### Question 26) What unusual file (for an American company) does winsys32.dll cause to be downloaded into the Frothly environment?

**Solution:** `나는_데이비드를_사랑한다.hwp`

##### Question 27) What is the first and last name of the poor innocent sap who was implicated in the metadata of the file that executed PowerShell Empire on the first victim's workstation? Answer example: John Smith

**Solution:** Ryan Kovar

##### Question 28) Within the document, what kind of points is mentioned if you found the text?

**Solution:** CyberEastEgg

##### Question 29) To maintain persistence in the Frothly network, Taedonggang APT configured several Scheduled Tasks to beacon back to their C2 server. What single webpage is most contacted by these Scheduled Tasks? Answer example: index.php or images.html

**Solution:** process.php

#### Task 7: Conclusion

Congratulations you finished the [Splunk 2](https://tryhackme.com/room/splunk2gcd5) room on [TryHackMe](https://tryhackme.com/).

If you want to dive deeper into the art of hunting APTs with Splunk feel free to download the complete dataset into a local Splunk instance.

##### Question 30)

Click the `Completed` button to finish this room.